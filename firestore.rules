rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================================
    // HELPER FUNCTIONS
    // ============================================================
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Safe user data retrieval - handles missing user documents
    function getUserData() {
      let userDoc = get(/databases/$(database)/documents/users/$(request.auth.uid));
      return userDoc.exists ? userDoc.data : null;
    }
    
    function hasRole(role) {
      let userData = getUserData();
      return userData != null && userData.role == role;
    }
    
    function isAdmin() {
      return isAuthenticated() && hasRole('ADMIN');
    }
    
    function isManager() {
      return isAuthenticated() && (hasRole('MANAGER') || hasRole('ADMIN'));
    }
    
    function isCashier() {
      return isAuthenticated() && (hasRole('CASHIER') || isManager());
    }
    
    function getUserBranchId() {
      let userData = getUserData();
      return userData != null ? userData.branchId : null;
    }
    
    // Transaction type validation - accepts INCOME and EXPENSE
    function isValidTransactionType(type) {
      return type == 'INCOME' || type == 'EXPENSE';
    }
    
    // Transaction schema validation with required fields
    function isValidTransactionData(data) {
      return data.keys().hasAll(['amount', 'type', 'branchId', 'date', 'description', 'createdBy']) &&
             data.amount is number && data.amount > 0 &&
             data.type is string && isValidTransactionType(data.type) &&
             data.branchId is string && data.branchId.size() > 0 &&
             data.date is string && data.date.size() > 0 &&
             data.description is string && data.description.size() > 0 &&
             data.createdBy is string && data.createdBy == request.auth.uid &&
             (!data.keys().hasAny(['items']) || data.items is list);
    }
    
    // ============================================================
    // COLLECTION RULES
    // ============================================================
    
    // --- Users Collection ---
    // SECURITY: Users CANNOT change their own role or branchId
    match /users/{userId} {
      allow read: if isAuthenticated() && 
        (request.auth.uid == userId || isManager());
      
      // CREATE: User can only create their own profile
      allow create: if isAuthenticated() && 
        request.auth.uid == userId;
      
      // UPDATE: Self-update CANNOT change role or branchId (anti-escalation)
      // Only ADMIN can change role/branchId
      allow update: if isAuthenticated() && (
        (
          request.auth.uid == userId &&
          request.resource.data.role == resource.data.role &&
          request.resource.data.branchId == resource.data.branchId
        ) || 
        isAdmin()
      );
      
      allow delete: if isAdmin();
    }

    // --- Products Collection ---
    match /products/{productId} {
      allow read: if isAuthenticated();
      allow write: if isManager();
    }

    // --- Transactions Collection ---
    // SECURITY REQUIREMENTS:
    // - Branch isolation: Users only see transactions from their branch
    // - Role-based creation: Cashiers+ can create, Managers+ can update/delete
    // - Type validation: Must be INCOME or EXPENSE
    // - Data integrity: Required fields validated
    match /transactions/{transactionId} {
      // READ: Admin sees all. Others only see their branch transactions.
      allow get: if isAuthenticated() && (
        isAdmin() || 
        (resource.data.branchId == getUserBranchId())
      );
      
      allow list: if isAuthenticated() && (
        isAdmin() || 
        (resource.data.branchId == getUserBranchId())
      );
      
      // CREATE: Cashier+ can create transactions for their branch only
      // Validates: branch matches user, amount > 0, valid type (INCOME/EXPENSE), 
      // required fields present
      allow create: if isCashier() && isValidTransactionData(request.resource.data) &&
        (
          isAdmin() || 
          request.resource.data.branchId == getUserBranchId()
        );

      // UPDATE: Managers+ only. Cannot change branchId for security.
      allow update: if isManager() && 
        isValidTransactionData(request.resource.data) &&
        (
          isAdmin() || 
          (
            resource.data.branchId == getUserBranchId() &&
            request.resource.data.branchId == resource.data.branchId
          )
        );
        
      allow delete: if isManager() && 
        (
          isAdmin() || 
          resource.data.branchId == getUserBranchId()
        );
    }
    
    // --- Branches Collection ---
    match /branches/{branchId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // --- Inventory Collection ---
    match /inventory/{inventoryId} {
      allow read: if isAuthenticated() && (
        isAdmin() || 
        resource.data.branchId == getUserBranchId()
      );
      allow write: if isManager() && (
        isAdmin() || 
        request.resource.data.branchId == getUserBranchId()
      );
    }

    // --- Access Control / Authorized Users ---
    match /access_users/{email} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }

    // --- Authorized IPs ---
    match /authorized_ips/{id} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // --- Categories Collection ---
    match /categories/{categoryId} {
      allow read: if isAuthenticated();
      allow write: if isManager();
    }
    
    // --- Settings/Configuration ---
    match /settings/{settingId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // --- Roles Collection ---
    match /roles/{roleId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // --- Inventory Movements (Audit Trail / Kardex) ---
    match /inventory_movements/{movementId} {
      allow read: if isAuthenticated() && (
        isAdmin() || 
        resource.data.branchId == getUserBranchId()
      );
      // Cashier+ can create movements for their own branch
      // Must include required fields and userId must match auth (admin exempt)
      allow create: if isCashier() && 
        request.resource.data.keys().hasAll(['productId', 'branchId', 'type', 'quantity', 'userId']) &&
        (
          isAdmin() || 
          (request.resource.data.branchId == getUserBranchId() && request.resource.data.userId == request.auth.uid)
        );
      
      // Movements are immutable once created (audit integrity)
      allow update, delete: if false;
    }
    
    // --- Stock Transfers ---
    match /stock_transfers/{transferId} {
      allow read: if isAuthenticated() && (
        isAdmin() || 
        resource.data.sourceBranchId == getUserBranchId() ||
        resource.data.targetBranchId == getUserBranchId()
      );
      allow create: if isManager() && 
        request.resource.data.sourceBranchId == getUserBranchId();
      allow update: if isManager() && (
        isAdmin() ||
        resource.data.sourceBranchId == getUserBranchId() ||
        resource.data.targetBranchId == getUserBranchId()
      );
      allow delete: if isAdmin();
    }
    
    // --- Inventory Batches (FIFO Cost Tracking) ---
    match /inventory_batches/{batchId} {
      allow read: if isAuthenticated() && (
        isAdmin() || 
        resource.data.branchId == getUserBranchId()
      );
      // Manager+ can create/update batches for their branch
      allow create: if isManager() && (
        isAdmin() || 
        request.resource.data.branchId == getUserBranchId()
      ) && request.resource.data.keys().hasAll(['productId', 'branchId', 'cost', 'initialStock', 'remainingStock']);
      
      allow update: if isCashier() && (
        isAdmin() || 
        resource.data.branchId == getUserBranchId()
      );
      allow delete: if isAdmin();
    }

    // --- Journal Entries (Accounting) ---
    match /journal_entries/{entryId} {
      allow read: if isAuthenticated() && (
        isAdmin() || 
        resource.data.branchId == getUserBranchId()
      );
      // Created during atomic sale transactions by Cashier+
      allow create: if isCashier() && 
        request.resource.data.keys().hasAll(['date', 'description', 'lines', 'totalAmount', 'branchId', 'createdBy']) &&
        request.resource.data.createdBy == request.auth.uid;
      // Only admin can modify posted entries
      allow update, delete: if isAdmin();
    }

    // --- Financial Summaries (pre-aggregated by Cloud Functions) ---
    match /financial_summaries/{summaryId} {
      allow read: if isAuthenticated() && isManager();
      // Only Cloud Functions can write (admin SDK bypasses rules)
      allow create, update, delete: if false;
    }

    // --- Inventory Valuations (pre-aggregated by Cloud Functions) ---
    match /inventory_valuations/{valuationId} {
      allow read: if isAuthenticated() && isManager();
      allow create, update, delete: if false;
    }

    // --- Archived Inventory Batches (moved by Cloud Functions) ---
    match /inventory_batches_archive/{batchId} {
      allow read: if isAuthenticated() && isAdmin();
      allow create, update, delete: if false;
    }

    // --- Audit Logs ---
    match /audit_logs/{logId} {
      allow read: if isAuthenticated() && (
        isAdmin() || 
        resource.data.userId == request.auth.uid
      );
      allow create, update, delete: if false;
    }
    
    // --- Fallback: Deny All ---
    // Any collection not explicitly defined above is denied
    match /{document=**} {
      allow read: if false;
      allow write: if false;
    }
  }
}
